#!/usr/bin/env bash

# Dialog script for smoothing wine fonts
# Author: owl4ce
# License: GPL-3.0
# ---------------------------------------
# https://github.com/owl4ce/wfs

export NEWT_COLORS="
root=,black
shadow=,black
window=,lightgray
border=lightgray,lightgray
textbox=lightgray,gray
listbox=black,lightgray
actlistbox=magenta,lightgray
actsellistbox=red,lightgray
button=green,lightgray"

if [[ ! -x "$(which "wine" 2> /dev/null)" ]]; then
    echo -e "\e[1;31mWine not found, has it been installed?"
    exit 1
fi

DIALOG="whiptail"
[[ ! -x "$(which "$DIALOG" 2> /dev/null)" ]] && DIALOG="dialog"

TMPFILE="$(mktemp)" || exit 1
$DIALOG --menu \
    "                Smoothing Mode" 11 49\
    3\
        1. "ClearType smoothing: RGB (subpixel)"\
        2. "ClearType smoothing: BGR (subpixel)"\
        3. "Disable smoothing" 2> $TMPFILE
STATUS="$?"
ANSWER="$(cat $TMPFILE)"

if [[ "$STATUS" != 0 ]]; then 
    rm -f "$TMPFILE"
    exit 1
fi

# Default mode (disabled)
MODE=0 # 0 = Disabled; 2 = Enabled
TYPE=0 # 1 = Regular;  2 = Subpixel
ORIENTATION=1 # 0 = BGR; 1 = RGB

case $ANSWER in
    1.) MODE=2 # Enable ClearType RGB
        TYPE=2
    ;;
    2.) MODE=2 # Enable ClearType BGR
        TYPE=2
        ORIENTATION=0
    ;;
    3.) # Disable
    ;;
    *)  rm -f "$TMPFILE"
        echo "Unexpected option: $ANSWER"
        exit 1
    ;;
esac

echo "REGEDIT4

[HKEY_CURRENT_USER\Control Panel\Desktop]
\"FontSmoothing\"=\"$MODE\"
\"FontSmoothingOrientation\"=dword:0000000$ORIENTATION
\"FontSmoothingType\"=dword:0000000$TYPE
\"FontSmoothingGamma\"=dword:00000578" > $TMPFILE

clear
echo -n -e "\e[1;36mApplying changes... "
$WINE regedit $TMPFILE 2> /dev/null
rm -f $TMPFILE
echo -e "\e[1;32mOK"
