#!/usr/bin/env bash

# Dialog bash script for smoothing wine fonts
# Author: owl4ce
# License: GPL-3.0
# --------------------------------------------
# https://github.com/owl4ce/wfs

R="\e[1;31m"; G="\e[1;32m"; M="\e[1;35m"; C="\e[1;36m"; W="\e[1;37m"; NC="\e[0m"

export NEWT_COLORS="
root=,black
shadow=,black
window=,lightgray
border=lightgray,lightgray
textbox=lightgray,gray
listbox=black,lightgray
actlistbox=magenta,lightgray
actsellistbox=red,lightgray
button=green,lightgray"

if [[ ! "$(command -v "wine")" ]]; then
    echo -e "${R}Wine not found!${W} Is it installed?${NC}"
    exit 1
fi

if [[ "$(command -v "whiptail")" ]]; then
    DIALOG="whiptail"
elif [[ "$(command -v "dialog")" ]]; then
    DIALOG="dialog"
else
    echo -e "${R}Error!${W} There's no ${M}whiptail${W} or ${M}dialog${W} installed.${NC}"
fi

TMPFILE="$(mktemp)" || exit 1
$DIALOG --menu \
    "                Smoothing Mode" 11 49\
    3\
        1. "ClearType smoothing: RGB (subpixel)"\
        2. "ClearType smoothing: BGR (subpixel)"\
        3. "Disable smoothing" 2> $TMPFILE
STATUS="$?"
ANSWER="$(cat $TMPFILE)"

[[ "$STATUS" != "0" ]] && rm -f "$TMPFILE" && exit 1

# Default mode (disabled)
MODE=0 # 0 = Disabled; 2 = Enabled
TYPE=0 # 1 = Regular;  2 = Subpixel
ORIENTATION=1 # 0 = BGR; 1 = RGB

case $ANSWER in
    1.) MODE=2 # Enable ClearType RGB
        TYPE=2
    ;;
    2.) MODE=2 # Enable ClearType BGR
        TYPE=2
        ORIENTATION=0
    ;;
    3.) # Disable
    ;;
    *)  rm -f "$TMPFILE"
        echo "${R}Unexpected option:${W} $ANSWER${NC}"
        exit 1
    ;;
esac

echo "REGEDIT4

[HKEY_CURRENT_USER\Control Panel\Desktop]
\"FontSmoothing\"=\"$MODE\"
\"FontSmoothingOrientation\"=dword:0000000$ORIENTATION
\"FontSmoothingType\"=dword:0000000$TYPE
\"FontSmoothingGamma\"=dword:00000578" > $TMPFILE

printf "\033c"
echo -n -e "${C}Applying changes... "
    $WINE regedit $TMPFILE 2> /dev/null
    rm -f $TMPFILE
echo -e "${G}OK${NC}"
